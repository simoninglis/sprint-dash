#!/usr/bin/env bash
# Use normalized session name from workon, or derive from directory name
SESSION="${TMUX_SESSION_NAME:-sprint-dash}"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

unset ANTHROPIC_API_KEY

if ! tmux has-session -t "=$SESSION" 2>/dev/null; then
    tmux new-session -d -s $SESSION -c "$SCRIPT_DIR" -n nvim
    tmux new-window -t $SESSION:1 -n claude -c "$SCRIPT_DIR"
    tmux new-window -t $SESSION:2 -n shell -c "$SCRIPT_DIR"
    tmux new-window -t $SESSION:3 -n server -c "$SCRIPT_DIR"

    tmux send-keys -t $SESSION:0 'nvim .' C-m

    # Claude usage in status bar (5h and 7d utilization with color coding)
    tmux set-option -t $SESSION status-right-length 60
    tmux set-option -t $SESSION status-right '#(~/.local/bin/claude-usage) â”‚ %H:%M %d-%b'
fi

# Smart attach/switch using centralized helper (prevents nested tmux)
~/.local/bin/tmux-join "=$SESSION:0"
