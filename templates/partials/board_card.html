{# Board card - expects 'issue' to be a BoardIssue #}
<div class="board-card card-{{ issue.state }} {% if issue.is_blocked %}card-blocked{% elif issue.needs_polish and issue.state == 'open' %}card-polish{% endif %}"
     style="--epic-color: {{ issue.epic_color }};"
     data-issue-number="{{ issue.number }}"
     hx-get="{{ repo_url('/issues/' ~ issue.number) }}"
     hx-target="#content"
     hx-push-url="true">

    {# Epic color rail (top bar) #}
    {% if issue.epic %}
    <div class="card-epic-rail"></div>
    {% endif %}

    {# Status banners - priority: closed > blocked > needs-polish #}
    {% if issue.state == "closed" %}
    <div class="card-status-banner card-closed-banner">
        <span class="status-icon">&#x2713;</span> DONE
    </div>
    {% elif issue.is_blocked %}
    <div class="card-status-banner card-blocked-banner">
        <span class="status-icon">&#x26A0;</span> BLOCKED
    </div>
    {% elif issue.needs_polish and issue.state == "open" %}
    <div class="card-status-banner card-polish-banner">
        <span class="status-icon">&#x270E;</span> NEEDS POLISH
    </div>
    {% endif %}

    <div class="card-header">
        <span class="card-number">#{{ issue.number }}</span>
        <div class="card-badges">
            {% if issue.priority %}
            <span class="mini-badge priority-{{ issue.priority }}">P{{ issue.priority }}</span>
            {% endif %}
            {% if issue.size %}
            <span class="mini-badge size-{{ issue.size|lower }}">{{ issue.size }}</span>
            {% endif %}
        </div>
    </div>

    <div class="card-title">{{ issue.title }}</div>

    <div class="card-meta">
        <span class="mini-badge type-{{ issue.issue_type }}">{{ issue.issue_type }}</span>
        {% if issue.is_ready and issue.state == "open" %}
        <span class="mini-badge ready">ready</span>
        {% endif %}
        {% if issue.epic %}
        <span class="mini-badge epic" title="{{ issue.epic }}"
              hx-get="{{ repo_url('/board') }}?epic_filter={{ issue.epic|urlencode }}"
              hx-target="#board-content"
              hx-include=".board-filter"
              onclick="event.stopPropagation();">
            {{ issue.epic[:12] }}{% if issue.epic|length > 12 %}...{% endif %}
        </span>
        {% endif %}
    </div>

    {# Dependency badges #}
    {% if issue.blocked_by_count > 0 or issue.blocks_count > 0 %}
    <div class="card-deps">
        {% if issue.blocked_by_count > 0 %}
        <span class="dep-badge dep-blocked" title="Blocked by {{ issue.blocked_by_count }} issue(s)">
            &#x26D3; {{ issue.open_blocker_count }}{% if issue.blocker_context %} &middot; {{ issue.blocker_context }}{% endif %}
        </span>
        {% endif %}
        {% if issue.blocks_count > 0 %}
        <span class="dep-badge dep-blocks" title="Blocks {{ issue.blocks_count }} issue(s)">
            &#x2192; {{ issue.blocks_count }}
        </span>
        {% endif %}
    </div>
    {% endif %}

    {# Quick-action buttons (visible on hover) #}
    {% if issue.state == 'open' and current_sprint_num is defined %}
    <div class="card-actions" onclick="event.stopPropagation();">
        {% if issue.sprint and issue.sprint != current_sprint_num %}
        <button class="card-action-btn"
                title="Move to Sprint {{ current_sprint_num }}"
                hx-post="{{ repo_url('/api/sprints/' ~ current_sprint_num ~ '/issues/' ~ issue.number) }}"
                hx-vals='{"from_sprint": "{{ issue.sprint }}"}'
                hx-target="#board-content"
                hx-swap="innerHTML">&#x2192; S{{ current_sprint_num }}</button>
        {% endif %}
        {% if issue.sprint %}
        <button class="card-action-btn"
                title="Remove from sprint"
                hx-delete="{{ repo_url('/api/sprints/' ~ issue.sprint ~ '/issues/' ~ issue.number) }}"
                hx-target="#board-content"
                hx-swap="innerHTML">&#x2715;</button>
        {% elif current_sprint_num %}
        <button class="card-action-btn"
                title="Add to Sprint {{ current_sprint_num }}"
                hx-post="{{ repo_url('/api/sprints/' ~ current_sprint_num ~ '/issues/' ~ issue.number) }}"
                hx-target="#board-content"
                hx-swap="innerHTML">&#x2192; S{{ current_sprint_num }}</button>
        {% endif %}
    </div>
    {% endif %}
</div>
