<!-- Hidden center param stays in sync with navigation -->
{% if center_sprint_num %}
<input type="hidden" class="board-filter" name="center" value="{{ center_sprint_num }}">
{% endif %}

<!-- Navigation Header -->
{% if center_sprint_num %}
<div class="board-nav">
    <button class="nav-btn {% if not can_go_back %}disabled{% endif %}"
            {% if can_go_back %}
            hx-get="{{ repo_url('/board') }}?center={{ center_sprint_num - 1 }}&show_closed={{ show_closed }}&type_filter={{ type_filter|urlencode }}&epic_filter={{ epic_filter|urlencode }}&group_by_epic={{ group_by_epic }}"
            hx-target="#board-content"
            hx-push-url="true"
            {% endif %}
            {% if not can_go_back %}disabled{% endif %}>
        ← Earlier
    </button>
    <span class="nav-info">
        Viewing sprints around
        <strong>Sprint {{ center_sprint_num }}</strong>
        {% if center_sprint_num != current_sprint_num %}
        <a href="{{ repo_url('/board') }}?show_closed={{ show_closed }}&type_filter={{ type_filter|urlencode }}&epic_filter={{ epic_filter|urlencode }}&group_by_epic={{ group_by_epic }}"
           hx-get="{{ repo_url('/board') }}?show_closed={{ show_closed }}&type_filter={{ type_filter|urlencode }}&epic_filter={{ epic_filter|urlencode }}&group_by_epic={{ group_by_epic }}"
           hx-target="#board-content"
           hx-push-url="true"
           style="color: var(--accent); margin-left: 0.5rem;">
            ↩ Back to current
        </a>
        {% endif %}
    </span>
    <button class="nav-btn {% if not can_go_forward %}disabled{% endif %}"
            {% if can_go_forward %}
            hx-get="{{ repo_url('/board') }}?center={{ center_sprint_num + 1 }}&show_closed={{ show_closed }}&type_filter={{ type_filter|urlencode }}&epic_filter={{ epic_filter|urlencode }}&group_by_epic={{ group_by_epic }}"
            hx-target="#board-content"
            hx-push-url="true"
            {% endif %}
            {% if not can_go_forward %}disabled{% endif %}>
        Later →
    </button>
</div>
{% else %}
<div class="board-nav">
    <span class="nav-info">No sprints found in this repository</span>
</div>
{% endif %}

<div class="board-grid" style="grid-template-columns: repeat({{ columns }}, 1fr);">
    <!-- Backlog Column (Ready Queue) -->
    <div class="board-column backlog-column">
        <div class="column-header">
            <div class="column-title">Backlog (Ready)</div>
            <div class="column-stats">
                {{ ready_backlog|length }} issues
                (~{{ ready_backlog|sum(attribute='points') }} pts)
                {% if backlog_blocked_count > 0 %}
                <span class="column-blocked-count">&#x26D4; {{ backlog_blocked_count }} blocked</span>
                {% endif %}
            </div>
        </div>
        <div class="column-body">
            {% if ready_backlog %}
                {% if group_by_epic %}
                    {% set epics_seen = {} %}
                    {% for issue in ready_backlog %}
                        {% set epic_name = issue.epic or "No Epic" %}
                        {% if epic_name not in epics_seen %}
                            {% set _ = epics_seen.update({epic_name: true}) %}
                            <details class="epic-group" open>
                                <summary class="epic-group-header" style="--epic-color: {{ issue.epic_color }};">
                                    {{ epic_name }}
                                    <span class="epic-group-count">
                                        ({{ ready_backlog|selectattr('epic', 'equalto', issue.epic)|list|length if issue.epic else ready_backlog|selectattr('epic', 'none')|list|length }})
                                    </span>
                                </summary>
                                <div class="epic-group-body">
                                    {% for grouped_issue in ready_backlog %}
                                        {% if (grouped_issue.epic or "No Epic") == epic_name %}
                                            {% with issue=grouped_issue %}
                                            {% include "partials/board_card.html" %}
                                            {% endwith %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </details>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    {% for issue in ready_backlog %}
                    {% include "partials/board_card.html" %}
                    {% endfor %}
                {% endif %}
            {% else %}
                <div class="column-empty">No ready issues in backlog</div>
            {% endif %}
        </div>
    </div>

    <!-- Sprint Columns -->
    {% for sprint, issues, blocked_count, polish_count in sprint_columns %}
    <div class="board-column {% if sprint.number == current_sprint_num %}current-sprint{% endif %}">
        <div class="column-header">
            <div class="column-title">
                Sprint {{ sprint.number }}
                <span class="lifecycle-indicator lifecycle-{{ sprint.lifecycle_state }}">
                    {{ sprint.lifecycle_indicator }}
                </span>
                {% if sprint.number == current_sprint_num %}
                <span style="color: var(--success); font-size: 0.75rem;">(current)</span>
                {% if ci_health and ci_health.state != "unknown" %}
                <span class="ci-indicator ci-{{ ci_health.state }}" title="CI: {{ ci_health.state }} ({{ ci_health.sha }})" aria-label="CI status: {{ ci_health.state }}">
                    {% if ci_health.state == "success" %}✓{% elif ci_health.state == "failure" %}✗{% elif ci_health.state == "running" %}⏳{% elif ci_health.state == "cancelled" %}⊘{% elif ci_health.state == "pending" %}⏳{% elif ci_health.state == "skipped" %}–{% else %}○{% endif %}
                </span>
                {% endif %}
                {% endif %}
            </div>
            <div class="column-stats">
                {{ sprint.closed_count }}/{{ sprint.total }} done
                {% if polish_count > 0 %}
                <span class="needs-polish-count">({{ polish_count }} polish)</span>
                {% endif %}
                ({{ sprint.progress_pct }}%)
                <span style="margin-left: 0.5rem; color: var(--text-muted);">
                    ~{{ sprint.total_points }} pts
                </span>
                {% if blocked_count > 0 %}
                <span class="column-blocked-count">&#x26D4; {{ blocked_count }} blocked</span>
                {% endif %}
            </div>
            <div class="column-progress">
                <div class="column-progress-fill" style="width: {{ sprint.progress_pct }}%"></div>
            </div>
            <!-- CI pipeline status below progress bar (or placeholder for consistent height) -->
            <div class="ci-pipeline">
                {% if sprint.number == current_sprint_num and ci_health and ci_health.workflows %}
                    {% for abbrev, status, icon, url in ci_health.workflow_abbrevs %}
                    {% if url %}
                    <a href="{{ url }}" target="_blank" rel="noopener noreferrer" class="ci-step ci-{{ status }}" title="View {{ abbrev }} logs" aria-label="{{ abbrev }} workflow: {{ status }}">{{ abbrev }}:{{ icon }}</a>
                    {% else %}
                    <span class="ci-step ci-{{ status }}" title="{% if status == 'not_run' %}Not run yet{% else %}{{ status }}{% endif %}" aria-label="{{ abbrev }} workflow: {{ status }}">{{ abbrev }}:{{ icon }}</span>
                    {% endif %}
                    {% endfor %}
                {% else %}
                    &nbsp;
                {% endif %}
            </div>
        </div>
        <div class="column-body">
            {% if issues %}
                {% if group_by_epic %}
                    {% set epics_seen = {} %}
                    {% for issue in issues %}
                        {% set epic_name = issue.epic or "No Epic" %}
                        {% if epic_name not in epics_seen %}
                            {% set _ = epics_seen.update({epic_name: true}) %}
                            <details class="epic-group" open>
                                <summary class="epic-group-header" style="--epic-color: {{ issue.epic_color }};">
                                    {{ epic_name }}
                                    <span class="epic-group-count">
                                        ({{ issues|selectattr('epic', 'equalto', issue.epic)|list|length if issue.epic else issues|selectattr('epic', 'none')|list|length }})
                                    </span>
                                </summary>
                                <div class="epic-group-body">
                                    {% for grouped_issue in issues %}
                                        {% if (grouped_issue.epic or "No Epic") == epic_name %}
                                            {% with issue=grouped_issue %}
                                            {% include "partials/board_card.html" %}
                                            {% endwith %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </details>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    {% for issue in issues %}
                    {% include "partials/board_card.html" %}
                    {% endfor %}
                {% endif %}
            {% else %}
                <div class="column-empty">
                    {% if show_closed %}
                    No issues in this sprint
                    {% else %}
                    No open issues
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}

    <!-- Empty columns if needed (for future sprints not yet created) -->
    {% if center_sprint_num %}
    {% set shown_columns = 1 + sprint_columns|length %}
    {% for i in range(columns - shown_columns) %}
    {% set empty_sprint_num = center_sprint_num + 2 - (columns - shown_columns - 1 - i) %}
    <div class="board-column">
        <div class="column-header">
            <div class="column-title">Sprint {{ empty_sprint_num }} <span class="lifecycle-indicator lifecycle-planned">◻</span></div>
            <div class="column-stats">Planning</div>
            <div class="column-progress">
                <div class="column-progress-fill" style="width: 0%"></div>
            </div>
            <div class="ci-pipeline">&nbsp;</div>
        </div>
        <div class="column-body">
            <div class="column-empty">
                No sprint created yet
            </div>
        </div>
    </div>
    {% endfor %}
    {% endif %}
</div>

<style>
    /* Navigation styles */
    .board-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background: var(--surface);
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .nav-btn {
        background: var(--primary);
        border: none;
        color: var(--text);
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.875rem;
        transition: background 0.2s;
    }

    .nav-btn:hover:not(.disabled) {
        background: var(--accent);
    }

    .nav-btn.disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .nav-info {
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    /* Epic grouping styles */
    .epic-group {
        margin-bottom: 0.75rem;
    }

    .epic-group-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background: var(--primary);
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        border-left: 3px solid var(--epic-color, var(--text-muted));
        list-style: none;
    }

    .epic-group-header::-webkit-details-marker {
        display: none;
    }

    .epic-group-header::before {
        content: "▶";
        font-size: 0.7rem;
        transition: transform 0.2s;
    }

    .epic-group[open] .epic-group-header::before {
        transform: rotate(90deg);
    }

    .epic-group-count {
        color: var(--text-muted);
        font-weight: normal;
    }

    .epic-group-body {
        padding-top: 0.5rem;
    }

    .needs-polish-count {
        color: #f59e0b;
        font-weight: 600;
    }
</style>
